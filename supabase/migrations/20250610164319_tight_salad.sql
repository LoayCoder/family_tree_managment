/*
  # إنشاء جدول النصوص والوثائق الشامل

  1. الجداول الجديدة
    - `النصوص_والوثائق` - جدول شامل للنصوص والوثائق المكتوبة
    
  2. الميزات
    - أنواع متعددة من النصوص (مذكرات، شعر، وثائق رسمية، إلخ)
    - ربط مع الأشخاص والنساء والأحداث والمواقع والمراجع
    - بحث نصي متقدم باللغة العربية
    - إحصائيات وتقارير شاملة
    - نظام خصوصية متدرج
    - تتبع القراءة والاستخدام
    
  3. الأمان
    - Row Level Security مفعل
    - سياسات حماية حسب مستوى الخصوصية
    - حماية بكلمة مرور للنصوص الحساسة
    
  4. الأداء
    - فهارس محسنة للبحث النصي
    - فهارس GIN للبحث في المصفوفات
    - فهارس للتواريخ والأهمية
*/

-- ========================================
-- جدول النصوص والوثائق الشامل
-- يدعم كل أنواع النصوص والوثائق المكتوبة
-- ========================================

CREATE TABLE IF NOT EXISTS "النصوص_والوثائق" (
    "معرف_النص"            SERIAL PRIMARY KEY,
    
    -- معلومات النص الأساسية
    "عنوان_النص"           VARCHAR(300) NOT NULL,
    "وصف_النص"             TEXT,
    "نوع_النص"             TEXT NOT NULL CHECK ("نوع_النص" IN (
        'قصة_مكتوبة',        -- قصص وحكايات مكتوبة
        'شعر_ونثر',          -- قصائد ونصوص أدبية
        'مذكرات_شخصية',     -- مذكرات ويوميات
        'رسائل_شخصية',      -- رسائل متبادلة
        'وثيقة_رسمية',      -- وثائق حكومية ورسمية
        'عقد_واتفاقية',     -- عقود وإتفاقيات
        'شهادة_ومؤهل',      -- شهادات دراسية ومهنية
        'تقرير_طبي',        -- تقارير وملفات طبية
        'كتاب_ومؤلف',       -- كتب ومؤلفات
        'مقال_ومحاضرة',     -- مقالات ونصوص محاضرات
        'فتوى_ونصيحة',      -- فتاوى ونصائح دينية
        'وصية_ووقف',        -- وصايا وأوقاف
        'نسب_وشجرة',        -- وثائق أنساب
        'تاريخ_وأحداث',      -- نصوص تاريخية
        'تعليم_وحكم',       -- نصوص تعليمية
        'أخرى'
    )),
    
    -- المحتوى النصي
    "النص_الكامل"          TEXT NOT NULL, -- النص الكامل للوثيقة
    "ملخص_النص"            TEXT, -- ملخص مختصر للنص
    "الكلمات_الافتتاحية"   TEXT, -- أول سطور النص
    "الكلمات_الختامية"     TEXT, -- آخر سطور النص
    
    -- معلومات الملف التقنية
    "مسار_الملف"           TEXT, -- URL أو مسار في Supabase Storage (للصورة المسحوبة)
    "نوع_الملف"            VARCHAR(10) CHECK ("نوع_الملف" IN ('pdf', 'doc', 'docx', 'txt', 'jpg', 'png', 'tiff')),
    "حجم_الملف"            BIGINT, -- بالبايت
    "عدد_الصفحات"          INTEGER, -- عدد الصفحات
    "عدد_الكلمات"          INTEGER, -- عدد الكلمات تقريباً
    
    -- ارتباطات مع الجداول الأخرى
    "معرف_الشخص"           BIGINT REFERENCES "الأشخاص"("id") ON DELETE SET NULL, -- الكاتب أو صاحب الوثيقة
    "معرف_المرأة"          INTEGER REFERENCES "النساء"("id") ON DELETE SET NULL, -- إذا كانت الكاتبة امرأة
    "معرف_الحدث"           INTEGER REFERENCES "الأحداث"("معرف_الحدث") ON DELETE SET NULL, -- الحدث المرتبط
    "معرف_المكان"          INTEGER REFERENCES "المواقع"("معرف_الموقع") ON DELETE SET NULL, -- مكان كتابة النص
    "معرف_المرجع"          INTEGER REFERENCES "المراجع"("معرف_المرجع") ON DELETE SET NULL, -- المرجع المرتبط
    
    -- تفاصيل الكتابة والإنشاء
    "تاريخ_الكتابة"        DATE, -- متى تم كتابة النص الأصلي
    "مكان_الكتابة_النصي"   TEXT, -- وصف نصي لمكان الكتابة
    "المناسبة"             TEXT, -- مناسبة كتابة النص
    "الكاتب_الأصلي"        TEXT, -- اسم الكاتب الأصلي (نصي)
    "المستقبل"             TEXT, -- إلى من موجه النص
    
    -- معلومات المحتوى
    "اللغة"                TEXT DEFAULT 'العربية',
    "اللهجة"               TEXT, -- "نجدية", "حجازية", "خليجية", "فصحى"
    "الخط_المستخدم"        TEXT, -- "رقعة", "نسخ", "ديواني", "مطبوع"
    "الكلمات_المفتاحية"    TEXT[], -- للبحث
    "الشخصيات_المذكورة"    TEXT[], -- أسماء مذكورة في النص
    "الأماكن_المذكورة"     TEXT[], -- أماكن مذكورة
    "التواريخ_المذكورة"    TEXT[], -- تواريخ مذكورة في النص
    
    -- تقييم ومعلومات إضافية
    "أهمية_النص"           TEXT CHECK ("أهمية_النص" IN ('عالية','متوسطة','عادية')) DEFAULT 'متوسطة',
    "مستوى_الوضوح"        TEXT CHECK ("مستوى_الوضوح" IN ('ممتاز','جيد','متوسط','ضعيف')) DEFAULT 'جيد',
    "حالة_الحفظ"           TEXT CHECK ("حالة_الحفظ" IN ('ممتازة','جيدة','متوسطة','تحتاج_ترميم')) DEFAULT 'جيدة',
    "حالة_الخط"            TEXT CHECK ("حالة_الخط" IN ('واضح','متوسط','صعب_القراءة','يحتاج_تفريغ')) DEFAULT 'واضح',
    "مستوى_الصحة"          TEXT CHECK ("مستوى_الصحة" IN ('موثق','محتمل','يحتاج_تحقق','مشكوك')) DEFAULT 'موثق',
    
    -- مصدر ونوع الحصول
    "مصدر_النص"            TEXT, -- "أرشيف العائلة", "مكتبة الملك فهد", "وجد في صندوق قديم"
    "طريقة_الحصول"        TEXT, -- "وراثة", "شراء", "إهداء", "نسخ"
    "المالك_الأصلي"        TEXT, -- من كان يملك النص قبل إدراجه
    
    -- معلومات النسخ والتفريغ
    "حالة_النسخ"           TEXT CHECK ("حالة_النسخ" IN ('أصلي','نسخة','نسخة_مصورة','مفرغ_نصياً')) DEFAULT 'أصلي',
    "مفرغ_بواسطة"          TEXT, -- من قام بتفريغ النص إلى الحاسوب
    "تاريخ_التفريغ"        DATE, -- متى تم تفريغ النص
    "ملاحظات_التفريغ"      TEXT, -- ملاحظات حول عملية التفريغ
    
    -- صور مرفقة
    "صورة_الغلاف"          TEXT, -- صورة الصفحة الأولى
    "صور_إضافية"          TEXT[], -- صور للصفحات الأخرى
    "صورة_صاحب_النص"       TEXT, -- صورة للكاتب إن وجدت
    
    -- متاح للعامة أم خاص
    "هو_عام"               BOOLEAN DEFAULT FALSE, -- هل يمكن للجميع قراءته
    "كلمة_مرور"            TEXT, -- لحماية النصوص الحساسة
    "مستوى_الخصوصية"      TEXT CHECK ("مستوى_الخصوصية" IN ('عام','عائلة','خاص','سري')) DEFAULT 'عائلة',
    
    -- معلومات الأرشفة
    "رقم_الأرشيف"          VARCHAR(50), -- رقم تصنيف في الأرشيف
    "موقع_الحفظ"           TEXT, -- مكان حفظ النسخة الأصلية
    "مدخل_البيانات"       TEXT, -- من أدخل البيانات
    "ملاحظات_أرشيفية"     TEXT,
    "تاريخ_الإدخال"        TIMESTAMP DEFAULT NOW(),
    "تاريخ_التحديث"       TIMESTAMP DEFAULT NOW(),
    "تاريخ_آخر_قراءة"      TIMESTAMP,
    "عدد_مرات_القراءة"     INTEGER DEFAULT 0,
    
    -- معلومات إضافية
    "العبرة_أو_الفائدة"     TEXT, -- الفائدة المستخلصة من النص
    "ملاحظات_عامة"        TEXT
);

-- ========================================
-- فهارس للبحث والأداء
-- ========================================

-- فهارس أساسية
CREATE INDEX IF NOT EXISTS "idx_نصوص_عنوان" ON "النصوص_والوثائق" ("عنوان_النص");
CREATE INDEX IF NOT EXISTS "idx_نصوص_نوع" ON "النصوص_والوثائق" ("نوع_النص");
CREATE INDEX IF NOT EXISTS "idx_نصوص_شخص" ON "النصوص_والوثائق" ("معرف_الشخص");
CREATE INDEX IF NOT EXISTS "idx_نصوص_امرأة" ON "النصوص_والوثائق" ("معرف_المرأة");
CREATE INDEX IF NOT EXISTS "idx_نصوص_حدث" ON "النصوص_والوثائق" ("معرف_الحدث");
CREATE INDEX IF NOT EXISTS "idx_نصوص_مكان" ON "النصوص_والوثائق" ("معرف_المكان");
CREATE INDEX IF NOT EXISTS "idx_نصوص_تاريخ" ON "النصوص_والوثائق" ("تاريخ_الكتابة");
CREATE INDEX IF NOT EXISTS "idx_نصوص_أهمية" ON "النصوص_والوثائق" ("أهمية_النص");
CREATE INDEX IF NOT EXISTS "idx_نصوص_مرجع" ON "النصوص_والوثائق" ("معرف_المرجع");
CREATE INDEX IF NOT EXISTS "idx_نصوص_أرشيف" ON "النصوص_والوثائق" ("رقم_الأرشيف");
CREATE INDEX IF NOT EXISTS "idx_نصوص_خصوصية" ON "النصوص_والوثائق" ("مستوى_الخصوصية");
CREATE INDEX IF NOT EXISTS "idx_نصوص_عام" ON "النصوص_والوثائق" ("هو_عام") WHERE "هو_عام" = TRUE;

-- فهارس للبحث النصي المتقدم
CREATE INDEX IF NOT EXISTS "idx_نصوص_كلمات" ON "النصوص_والوثائق" USING GIN ("الكلمات_المفتاحية");
CREATE INDEX IF NOT EXISTS "idx_نصوص_شخصيات" ON "النصوص_والوثائق" USING GIN ("الشخصيات_المذكورة");
CREATE INDEX IF NOT EXISTS "idx_نصوص_أماكن" ON "النصوص_والوثائق" USING GIN ("الأماكن_المذكورة");
CREATE INDEX IF NOT EXISTS "idx_نصوص_تواريخ" ON "النصوص_والوثائق" USING GIN ("التواريخ_المذكورة");
CREATE INDEX IF NOT EXISTS "idx_نصوص_صور" ON "النصوص_والوثائق" USING GIN ("صور_إضافية");

-- فهارس للبحث النصي الكامل
CREATE INDEX IF NOT EXISTS "idx_نصوص_نص_كامل" ON "النصوص_والوثائق" 
    USING GIN (to_tsvector('arabic', COALESCE("النص_الكامل", '')));
CREATE INDEX IF NOT EXISTS "idx_نصوص_ملخص" ON "النصوص_والوثائق" 
    USING GIN (to_tsvector('arabic', COALESCE("ملخص_النص", '')));
CREATE INDEX IF NOT EXISTS "idx_نصوص_وصف" ON "النصوص_والوثائق" 
    USING GIN (to_tsvector('arabic', COALESCE("وصف_النص", '')));

-- ========================================
-- وظائف البحث في النصوص والوثائق
-- ========================================

-- البحث العام في النصوص والوثائق
CREATE OR REPLACE FUNCTION search_text_documents(search_term TEXT)
RETURNS TABLE (
    معرف_النص INTEGER,
    عنوان_النص VARCHAR,
    نوع_النص TEXT,
    اسم_الكاتب TEXT,
    تاريخ_الكتابة DATE,
    أهمية_النص TEXT,
    ملخص_النص TEXT,
    عدد_الكلمات INTEGER,
    مستوى_الخصوصية TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        td."معرف_النص",
        td."عنوان_النص",
        td."نوع_النص",
        COALESCE(
            (SELECT "الاسم_الكامل" FROM "عرض_الأشخاص_كامل" WHERE "id" = td."معرف_الشخص"),
            (SELECT CONCAT_WS(' ', "الاسم_الأول", "اسم_الأب", "اسم_العائلة") FROM "النساء" WHERE "id" = td."معرف_المرأة"),
            td."الكاتب_الأصلي",
            'غير محدد'
        ) as writer_name,
        td."تاريخ_الكتابة",
        td."أهمية_النص",
        td."ملخص_النص",
        td."عدد_الكلمات",
        td."مستوى_الخصوصية"
    FROM "النصوص_والوثائق" td
    WHERE td."عنوان_النص" ILIKE '%' || search_term || '%'
       OR td."النص_الكامل" ILIKE '%' || search_term || '%'
       OR td."ملخص_النص" ILIKE '%' || search_term || '%'
       OR td."وصف_النص" ILIKE '%' || search_term || '%'
       OR td."الكاتب_الأصلي" ILIKE '%' || search_term || '%'
       OR search_term = ANY(td."الكلمات_المفتاحية")
       OR search_term = ANY(td."الشخصيات_المذكورة")
       OR search_term = ANY(td."الأماكن_المذكورة")
    ORDER BY td."أهمية_النص" DESC, td."تاريخ_الكتابة" DESC;
END;
$$ LANGUAGE plpgsql;

-- البحث المتقدم في النصوص
CREATE OR REPLACE FUNCTION advanced_text_search(
    search_term TEXT DEFAULT NULL,
    text_type TEXT DEFAULT NULL,
    person_id BIGINT DEFAULT NULL,
    woman_id INTEGER DEFAULT NULL,
    importance_level TEXT DEFAULT NULL,
    privacy_level TEXT DEFAULT NULL,
    date_from DATE DEFAULT NULL,
    date_to DATE DEFAULT NULL,
    language_filter TEXT DEFAULT NULL
)
RETURNS TABLE (
    معرف_النص INTEGER,
    عنوان_النص VARCHAR,
    نوع_النص TEXT,
    اسم_الكاتب TEXT,
    تاريخ_الكتابة DATE,
    أهمية_النص TEXT,
    مستوى_الخصوصية TEXT,
    عدد_الكلمات INTEGER,
    مكان_الكتابة TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        td."معرف_النص",
        td."عنوان_النص",
        td."نوع_النص",
        COALESCE(
            (SELECT "الاسم_الكامل" FROM "عرض_الأشخاص_كامل" WHERE "id" = td."معرف_الشخص"),
            (SELECT CONCAT_WS(' ', "الاسم_الأول", "اسم_الأب", "اسم_العائلة") FROM "النساء" WHERE "id" = td."معرف_المرأة"),
            td."الكاتب_الأصلي",
            'غير محدد'
        ) as writer_name,
        td."تاريخ_الكتابة",
        td."أهمية_النص",
        td."مستوى_الخصوصية",
        td."عدد_الكلمات",
        CASE 
            WHEN l."الدولة" IS NOT NULL THEN 
                CONCAT(l."الدولة", COALESCE(', ' || l."المنطقة", ''), COALESCE(', ' || l."المدينة", ''))
            ELSE td."مكان_الكتابة_النصي"
        END as مكان_الكتابة
    FROM "النصوص_والوثائق" td
    LEFT JOIN "المواقع" l ON td."معرف_المكان" = l."معرف_الموقع"
    WHERE (search_term IS NULL OR (
        td."عنوان_النص" ILIKE '%' || search_term || '%'
        OR td."النص_الكامل" ILIKE '%' || search_term || '%'
        OR td."ملخص_النص" ILIKE '%' || search_term || '%'
        OR search_term = ANY(td."الكلمات_المفتاحية")
    ))
    AND (text_type IS NULL OR td."نوع_النص" = text_type)
    AND (person_id IS NULL OR td."معرف_الشخص" = person_id)
    AND (woman_id IS NULL OR td."معرف_المرأة" = woman_id)
    AND (importance_level IS NULL OR td."أهمية_النص" = importance_level)
    AND (privacy_level IS NULL OR td."مستوى_الخصوصية" = privacy_level)
    AND (date_from IS NULL OR td."تاريخ_الكتابة" >= date_from)
    AND (date_to IS NULL OR td."تاريخ_الكتابة" <= date_to)
    AND (language_filter IS NULL OR td."اللغة" = language_filter)
    ORDER BY td."أهمية_النص" DESC, td."تاريخ_الكتابة" DESC;
END;
$$ LANGUAGE plpgsql;

-- إحصائيات النصوص والوثائق
CREATE OR REPLACE FUNCTION text_documents_statistics()
RETURNS TABLE (
    نوع_النص TEXT,
    عدد_النصوص BIGINT,
    إجمالي_الكلمات BIGINT,
    متوسط_الكلمات NUMERIC,
    عدد_النصوص_المهمة BIGINT,
    أحدث_نص DATE,
    أقدم_نص DATE
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        td."نوع_النص",
        COUNT(*) as text_count,
        SUM(td."عدد_الكلمات") as total_words,
        ROUND(AVG(td."عدد_الكلمات"), 0) as avg_words,
        COUNT(CASE WHEN td."أهمية_النص" = 'عالية' THEN 1 END) as important_count,
        MAX(td."تاريخ_الكتابة") as newest_text,
        MIN(td."تاريخ_الكتابة") as oldest_text
    FROM "النصوص_والوثائق" td
    GROUP BY td."نوع_النص"
    ORDER BY text_count DESC;
END;
$$ LANGUAGE plpgsql;

-- البحث بالفترة الزمنية
CREATE OR REPLACE FUNCTION search_texts_by_period(start_date DATE, end_date DATE)
RETURNS TABLE (
    معرف_النص INTEGER,
    عنوان_النص VARCHAR,
    نوع_النص TEXT,
    تاريخ_الكتابة DATE,
    أهمية_النص TEXT,
    اسم_الكاتب TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        td."معرف_النص",
        td."عنوان_النص",
        td."نوع_النص",
        td."تاريخ_الكتابة",
        td."أهمية_النص",
        COALESCE(
            (SELECT "الاسم_الكامل" FROM "عرض_الأشخاص_كامل" WHERE "id" = td."معرف_الشخص"),
            (SELECT CONCAT_WS(' ', "الاسم_الأول", "اسم_الأب", "اسم_العائلة") FROM "النساء" WHERE "id" = td."معرف_المرأة"),
            td."الكاتب_الأصلي",
            'غير محدد'
        ) as writer_name
    FROM "النصوص_والوثائق" td
    WHERE td."تاريخ_الكتابة" BETWEEN start_date AND end_date
    ORDER BY td."تاريخ_الكتابة" DESC, td."أهمية_النص" DESC;
END;
$$ LANGUAGE plpgsql;

-- الحصول على نصوص شخص معين
CREATE OR REPLACE FUNCTION get_person_texts(person_id BIGINT)
RETURNS TABLE (
    معرف_النص INTEGER,
    عنوان_النص VARCHAR,
    نوع_النص TEXT,
    تاريخ_الكتابة DATE,
    أهمية_النص TEXT,
    عدد_الكلمات INTEGER,
    ملخص_النص TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        td."معرف_النص",
        td."عنوان_النص",
        td."نوع_النص",
        td."تاريخ_الكتابة",
        td."أهمية_النص",
        td."عدد_الكلمات",
        td."ملخص_النص"
    FROM "النصوص_والوثائق" td
    WHERE td."معرف_الشخص" = person_id
       OR person_id::TEXT = ANY(td."الشخصيات_المذكورة")
    ORDER BY td."أهمية_النص" DESC, td."تاريخ_الكتابة" DESC;
END;
$$ LANGUAGE plpgsql;

-- إحصائيات شاملة للأرشيف النصي
CREATE OR REPLACE FUNCTION comprehensive_text_stats()
RETURNS TABLE (
    إجمالي_النصوص BIGINT,
    إجمالي_الكلمات BIGINT,
    إجمالي_الصفحات BIGINT,
    عدد_النصوص_العامة BIGINT,
    عدد_النصوص_الخاصة BIGINT,
    أكثر_نوع_شيوعا TEXT,
    متوسط_طول_النص NUMERIC,
    أقدم_نص DATE,
    أحدث_نص DATE
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        COUNT(*) as total_texts,
        SUM("عدد_الكلمات") as total_words,
        SUM("عدد_الصفحات") as total_pages,
        COUNT(*) FILTER (WHERE "هو_عام" = TRUE) as public_texts,
        COUNT(*) FILTER (WHERE "هو_عام" = FALSE) as private_texts,
        (SELECT "نوع_النص" FROM "النصوص_والوثائق" 
         GROUP BY "نوع_النص" 
         ORDER BY COUNT(*) DESC 
         LIMIT 1) as most_common_type,
        ROUND(AVG("عدد_الكلمات"), 0) as avg_text_length,
        MIN("تاريخ_الكتابة") as oldest_text,
        MAX("تاريخ_الكتابة") as newest_text
    FROM "النصوص_والوثائق";
END;
$$ LANGUAGE plpgsql;

-- ========================================
-- Triggers للتحديث التلقائي
-- ========================================

-- Trigger لتحديث إحصائيات القراءة
CREATE OR REPLACE FUNCTION update_text_reading_stats()
RETURNS TRIGGER AS $$
BEGIN
    -- إذا تم تحديث تاريخ آخر قراءة، نزيد العدد
    IF OLD."تاريخ_آخر_قراءة" IS DISTINCT FROM NEW."تاريخ_آخر_قراءة" 
       AND NEW."تاريخ_آخر_قراءة" IS NOT NULL THEN
        NEW."عدد_مرات_القراءة" := COALESCE(OLD."عدد_مرات_القراءة", 0) + 1;
    END IF;
    
    NEW."تاريخ_التحديث" := NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_update_text_stats
    BEFORE UPDATE ON "النصوص_والوثائق"
    FOR EACH ROW
    EXECUTE FUNCTION update_text_reading_stats();

-- Trigger لحساب عدد الكلمات تلقائياً
CREATE OR REPLACE FUNCTION auto_count_words()
RETURNS TRIGGER AS $$
BEGIN
    -- حساب عدد الكلمات تلقائياً إذا لم يكن محدداً
    IF NEW."عدد_الكلمات" IS NULL AND NEW."النص_الكامل" IS NOT NULL THEN
        NEW."عدد_الكلمات" := array_length(string_to_array(trim(NEW."النص_الكامل"), ' '), 1);
    END IF;
    
    -- استخراج الكلمات الافتتاحية والختامية تلقائياً
    IF NEW."الكلمات_الافتتاحية" IS NULL AND NEW."النص_الكامل" IS NOT NULL THEN
        NEW."الكلمات_الافتتاحية" := LEFT(NEW."النص_الكامل", 100);
    END IF;
    
    IF NEW."الكلمات_الختامية" IS NULL AND NEW."النص_الكامل" IS NOT NULL THEN
        NEW."الكلمات_الختامية" := RIGHT(NEW."النص_الكامل", 100);
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_auto_count_words
    BEFORE INSERT OR UPDATE ON "النصوص_والوثائق"
    FOR EACH ROW
    EXECUTE FUNCTION auto_count_words();

-- محفز تحديث تاريخ التحديث العام
CREATE TRIGGER "update_النصوص_والوثائق_updated_at"
    BEFORE UPDATE ON "النصوص_والوثائق"
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ========================================
-- Row Level Security للنصوص والوثائق
-- ========================================

ALTER TABLE "النصوص_والوثائق" ENABLE ROW LEVEL SECURITY;

-- سياسة للقراءة حسب مستوى الخصوصية
CREATE POLICY "Enable read access based on privacy level" ON "النصوص_والوثائق"
    FOR SELECT USING (
        "مستوى_الخصوصية" = 'عام' OR 
        ("مستوى_الخصوصية" = 'عائلة' AND "هو_عام" = TRUE) OR 
        "كلمة_مرور" IS NULL
    );

-- سياسة للإدراج - متاح للجميع
CREATE POLICY "Enable insert for all users" ON "النصوص_والوثائق"
    FOR INSERT WITH CHECK (true);

-- سياسة للتحديث - متاح للجميع
CREATE POLICY "Enable update for all users" ON "النصوص_والوثائق"
    FOR UPDATE USING (true);

-- سياسة للحذف - متاح للجميع
CREATE POLICY "Enable delete for all users" ON "النصوص_والوثائق"
    FOR DELETE USING (true);

-- ========================================
-- View للنصوص مع التفاصيل الكاملة
-- ========================================

CREATE OR REPLACE VIEW "عرض_النصوص_التفصيلي" AS
SELECT 
    td."معرف_النص",
    td."عنوان_النص",
    td."نوع_النص",
    td."وصف_النص",
    -- معلومات الكاتب
    COALESCE(
        (SELECT "الاسم_الكامل" FROM "عرض_الأشخاص_كامل" WHERE "id" = td."معرف_الشخص"),
        (SELECT CONCAT_WS(' ', "الاسم_الأول", "اسم_الأب", "اسم_العائلة") FROM "النساء" WHERE "id" = td."معرف_المرأة"),
        td."الكاتب_الأصلي"
    ) AS "اسم_الكاتب",
    CASE 
        WHEN td."معرف_الشخص" IS NOT NULL THEN 'رجل'
        WHEN td."معرف_المرأة" IS NOT NULL THEN 'امرأة'
        ELSE 'غير محدد'
    END AS "نوع_الكاتب",
    td."تاريخ_الكتابة",
    td."المناسبة",
    -- معلومات المحتوى
    td."ملخص_النص",
    td."عدد_الكلمات",
    td."عدد_الصفحات",
    td."اللغة",
    td."اللهجة",
    td."الخط_المستخدم",
    td."أهمية_النص",
    td."مستوى_الوضوح",
    td."حالة_الحفظ",
    td."حالة_الخط",
    td."مستوى_الصحة",
    -- معلومات المرجع
    mr."عنوان_المرجع",
    mr."نوع_المرجع",
    mr."مستوى_الثقة" AS "ثقة_المرجع",
    -- معلومات المكان
    CASE 
        WHEN l."الدولة" IS NOT NULL THEN 
            CONCAT(l."الدولة", COALESCE(', ' || l."المنطقة", ''), COALESCE(', ' || l."المدينة", ''))
        ELSE td."مكان_الكتابة_النصي"
    END AS "مكان_الكتابة",
    -- معلومات الأرشفة
    td."رقم_الأرشيف",
    td."موقع_الحفظ",
    td."مصدر_النص",
    td."طريقة_الحصول",
    td."حالة_النسخ",
    td."مستوى_الخصوصية",
    td."عدد_مرات_القراءة",
    td."تاريخ_الإدخال",
    td."تاريخ_التحديث",
    -- معلومات إضافية
    td."العبرة_أو_الفائدة",
    td."الكلمات_المفتاحية",
    td."الشخصيات_المذكورة",
    td."الأماكن_المذكورة"
FROM "النصوص_والوثائق" td
LEFT JOIN "المراجع" mr ON td."معرف_المرجع" = mr."معرف_المرجع"
LEFT JOIN "المواقع" l ON td."معرف_المكان" = l."معرف_الموقع";

-- ========================================
-- بيانات تجريبية
-- ========================================

-- أمثلة على نصوص ووثائق تجريبية
INSERT INTO "النصوص_والوثائق" (
    "عنوان_النص", 
    "نوع_النص", 
    "النص_الكامل", 
    "ملخص_النص", 
    "معرف_الشخص", 
    "تاريخ_الكتابة", 
    "أهمية_النص", 
    "الكلمات_المفتاحية", 
    "الكاتب_الأصلي",
    "اللهجة",
    "مصدر_النص",
    "مستوى_الخصوصية",
    "هو_عام"
) VALUES 
(
    'مذكرات الجد عبدالله - رحلة الحج عام 1370هـ', 
    'مذكرات_شخصية',
    'بسم الله الرحمن الرحيم، أكتب هذه الكلمات وأنا في طريقي إلى بيت الله الحرام في عام 1370 للهجرة. لقد كانت رحلة شاقة ولكنها مباركة، بدأناها من الرياض على ظهور الإبل وسط قافلة كبيرة من الحجاج. كان الطريق طويلاً ومليئاً بالتحديات، لكن الإيمان والعزيمة كانا رفيقينا في هذه الرحلة المقدسة...',
    'مذكرات شخصية مفصلة للجد عبدالله عن رحلة الحج التي قام بها عام 1370هـ، يصف فيها تفاصيل الرحلة والمشاعر والتجارب الروحانية',
    1, -- افتراض أن 1 هو معرف الجد عبدالله
    '1950-07-15',
    'عالية',
    ARRAY['حج', 'مذكرات', 'رحلة', 'تاريخ', 'روحانيات', 'إبل', 'قافلة'],
    'عبدالله بن محمد آل النجدي',
    'نجدية',
    'أرشيف العائلة - مخطوط أصلي',
    'عائلة',
    true
),
(
    'قصيدة في رثاء الوالد الكريم',
    'شعر_ونثر',
    'يا أبتاه وا حسرتاه عليك\nلقد كنت نوراً يضيء دروبي\nوكنت الحنان الذي يحتويني\nوكنت الأمان في كل خوفي\n\nرحلت وتركت قلبي كسيراً\nوعيني تذرف دمع الفراق\nولكن ذكراك باقية فينا\nوحبك محفور في الأعماق...',
    'قصيدة مؤثرة في رثاء الوالد كتبها الابن محمد بعد وفاة والده، تعبر عن الحزن العميق والحب الأبدي',
    2, -- افتراض أن 2 هو معرف محمد
    '1965-03-20',
    'متوسطة',
    ARRAY['شعر', 'رثاء', 'والد', 'حزن', 'ذكريات', 'حب'],
    'محمد بن عبدالله آل النجدي',
    'فصحى',
    'مكتوب بخط اليد - محفوظ في الأرشيف',
    'عائلة',
    true
),
(
    'وثيقة بيع أرض في الدرعية - عام 1340هـ',
    'وثيقة_رسمية',
    'بسم الله الرحمن الرحيم\nهذا ما اتفق عليه كل من البائع عبدالله بن محمد والمشتري سعد بن عبدالرحمن على بيع قطعة الأرض الواقعة في الدرعية...',
    'وثيقة رسمية لبيع قطعة أرض في الدرعية تعود لعام 1340هـ، تحتوي على تفاصيل البيع والشهود',
    1,
    '1921-05-10',
    'عالية',
    ARRAY['وثيقة', 'بيع', 'أرض', 'الدرعية', 'تاريخ', 'عقار'],
    'عبدالله بن محمد آل النجدي',
    'نجدية',
    'وثيقة أصلية محفوظة في صندوق العائلة',
    'خاص',
    false
),
(
    'رسالة إلى الابن في الغربة',
    'رسائل_شخصية',
    'ابني الحبيب محمد، أكتب إليك هذه الرسالة وأنا أشتاق إليك كثيراً. لقد مر على سفرك شهران ولم نتلق منك أي أخبار...',
    'رسالة عاطفية من الوالد إلى ابنه المسافر، تحمل مشاعر الشوق والنصائح الأبوية',
    1,
    '1955-11-25',
    'متوسطة',
    ARRAY['رسالة', 'أب', 'ابن', 'غربة', 'شوق', 'نصائح'],
    'عبدالله بن محمد آل النجدي',
    'نجدية',
    'رسالة محفوظة في مراسلات العائلة',
    'عائلة',
    true
) ON CONFLICT DO NOTHING;

-- ========================================
-- تعليقات توضيحية
-- ========================================

COMMENT ON TABLE "النصوص_والوثائق" IS 'جدول شامل لحفظ وإدارة النصوص والوثائق المكتوبة للعائلة مع نظام أرشفة متقدم';
COMMENT ON COLUMN "النصوص_والوثائق"."النص_الكامل" IS 'النص الكامل للوثيقة أو المحتوى المكتوب';
COMMENT ON COLUMN "النصوص_والوثائق"."معرف_المرجع" IS 'ربط النص بمرجع في جدول المراجع للتوثيق والمصداقية';
COMMENT ON COLUMN "النصوص_والوثائق"."مستوى_الخصوصية" IS 'تحديد مستوى إتاحة النص: عام (للجميع)، عائلة (للعائلة)، خاص (محدود)، سري (سري جداً)';
COMMENT ON COLUMN "النصوص_والوثائق"."رقم_الأرشيف" IS 'رقم تصنيف النص في نظام الأرشفة العائلي لسهولة الوصول والتنظيم';
COMMENT ON COLUMN "النصوص_والوثائق"."حالة_النسخ" IS 'تحديد ما إذا كان النص أصلي أم نسخة أم مفرغ نصياً من مخطوط';
COMMENT ON COLUMN "النصوص_والوثائق"."الشخصيات_المذكورة" IS 'أسماء الأشخاص المذكورين في النص لربطهم بالأشخاص في قاعدة البيانات';
COMMENT ON COLUMN "النصوص_والوثائق"."التواريخ_المذكورة" IS 'التواريخ المهمة المذكورة في النص لسهولة البحث التاريخي';
COMMENT ON COLUMN "النصوص_والوثائق"."العبرة_أو_الفائدة" IS 'الدروس المستفادة أو الفوائد المستخلصة من النص';